<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFC 4D Viewer with Dual Comparison</title>
    <style>
        body { margin: 0; overflow: hidden; display: flex; flex-direction: column; background-color: #000; }
        #viewers-container { 
            display: flex; 
            width: 100%; 
            height: 100vh; 
            transition: 0.5s ease-in-out; 
        }
        .viewer { 
            flex: 1; 
            position: relative; 
        }
        #slider-container1, #slider-container2 {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%; 
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }
        #date-label1, #date-label2 {
            display: block;
            margin-bottom: 10px;
        }
        #dashboard1, #dashboard2 {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 10px;
            width: 150px;
            text-align: right;
        }
        #toggle-button {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        @media (max-width: 768px) {
            #slider-container1, #slider-container2 {
                width: 100%; 
            }
            #dashboard1, #dashboard2 {
                width: 100px;
                font-size: 12px;
            }
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.skypack.dev/three@0.150.1",
                "web-ifc-three": "https://cdn.skypack.dev/web-ifc-three@0.0.38"
            }
        }
    </script>
</head>
<body>
    <div id="viewers-container">
        <div class="viewer" id="viewer1">
            <div id="container1"></div>
            <div id="slider-container1">
                <input type="range" id="time-slider1" min="0" max="100" value="0" step="1">
                <span id="date-label1"></span>
            </div>
            <div id="dashboard1">
                <h3>Área Total Visible</h3>
                <p id="area-value1">0 m²</p>
            </div>
        </div>
        <div class="viewer" id="viewer2" style="display: none;">
            <div id="container2"></div>
            <div id="slider-container2">
                <input type="range" id="time-slider2" min="0" max="100" value="0" step="1">
                <span id="date-label2"></span>
            </div>
            <div id="dashboard2">
                <h3>Área Total Visible</h3>
                <p id="area-value2">0 m²</p>
            </div>
        </div>
    </div>
    <button id="toggle-button">Comparar Modelos</button>

    <script type="module">
        import * as THREE from 'three';
        import { IFCLoader } from 'web-ifc-three/IFCLoader.js';

        const scene1 = new THREE.Scene();
        const camera1 = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer1 = new THREE.WebGLRenderer({ antialias: true });
        renderer1.setSize(window.innerWidth / 2, window.innerHeight);
        renderer1.setClearColor(0x000000); 
        document.getElementById('container1').appendChild(renderer1.domElement);

        const scene2 = new THREE.Scene();
        const camera2 = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer2 = new THREE.WebGLRenderer({ antialias: true });
        renderer2.setSize(window.innerWidth / 2, window.innerHeight);
        renderer2.setClearColor(0x000000); 
        document.getElementById('container2').appendChild(renderer2.domElement);

        camera1.position.set(10, 10, 20);
        camera2.position.set(10, 10, 20);

        const light1 = new THREE.AmbientLight(0xffffff, 0.5);
        scene1.add(light1);
        const directionalLight1 = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight1.position.set(10, 10, 10).normalize();
        scene1.add(directionalLight1);

        const light2 = new THREE.AmbientLight(0xffffff, 0.5);
        scene2.add(light2);
        const directionalLight2 = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight2.position.set(10, 10, 10).normalize();
        scene2.add(directionalLight2);

        const ifcLoader1 = new IFCLoader();
        const ifcLoader2 = new IFCLoader();
        ifcLoader1.ifcManager.setWasmPath("https://unpkg.com/web-ifc@0.0.38/");
        ifcLoader2.ifcManager.setWasmPath("https://unpkg.com/web-ifc@0.0.38/");

        let elementsByDate1, elementsByDate2;

        ifcLoader1.load('Modelo4D.ifc', async (ifcModel) => {
            scene1.add(ifcModel.mesh);
            await ifcLoader1.ifcManager.parser.setupOptionalCategories();
            elementsByDate1 = await extract4DElements(ifcModel, ifcLoader1);
            setupSlider(elementsByDate1, 1);
            camera1.lookAt(ifcModel.mesh.position);
        });

        ifcLoader2.load('Modelo4D.ifc', async (ifcModel) => {
            scene2.add(ifcModel.mesh);
            await ifcLoader2.ifcManager.parser.setupOptionalCategories();
            elementsByDate2 = await extract4DElements(ifcModel, ifcLoader2);
            setupSlider(elementsByDate2, 2);
            camera2.lookAt(ifcModel.mesh.position);
        });

        async function extract4DElements(ifcModel, ifcLoader) {
            const elementsByDate = {};
            const allItems = ifcModel.mesh.geometry.attributes.expressID.array;

            for (let i = 0; i < allItems.length; i++) {
                const expressID = allItems[i];
                const properties = await ifcLoader.ifcManager.getItemProperties(0, expressID);
                const date = await get4DDateForElement(properties, expressID, ifcLoader);

                if (date) {
                    const area = calculateArea(properties);

                    if (!elementsByDate[date]) elementsByDate[date] = { elements: [], totalArea: 0 };
                    elementsByDate[date].elements.push(ifcModel.mesh.getObjectById(expressID));
                    elementsByDate[date].totalArea += area;
                    ifcModel.mesh.getObjectById(expressID).visible = false;
                }
            }

            return elementsByDate;
        }

        async function get4DDateForElement(properties, expressID, ifcLoader) {
            const propertySets = await ifcLoader.ifcManager.getItemProperties(0, expressID, 'IFC4.IFCPROPERTYSET');
            // Implement extraction logic for date or time here
            return "some-date"; 
        }

        function calculateArea(properties) {
            // Implement area calculation based on properties
            return 0; 
        }

        function setupSlider(elementsByDate, viewer) {
            const slider = document.getElementById(`time-slider${viewer}`);
            const dateLabel = document.getElementById(`date-label${viewer}`);
            const areaValue = document.getElementById(`area-value${viewer}`);

            slider.addEventListener('input', () => {
                const value = parseInt(slider.value);
                const date = Object.keys(elementsByDate)[value];
                dateLabel.textContent = date || 'N/A';
                updateVisibility(elementsByDate, date, viewer);
                areaValue.textContent = (elementsByDate[date] ? elementsByDate[date].totalArea.toFixed(2) : 0) + ' m²';
            });
        }

        function updateVisibility(elementsByDate, date, viewer) {
            for (const key in elementsByDate) {
                elementsByDate[key].elements.forEach(el => {
                    el.visible = (key === date);
                });
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer1.render(scene1, camera1);
            renderer2.render(scene2, camera2);
        }
        animate();

        document.getElementById('toggle-button').addEventListener('click', () => {
            const container1 = document.getElementById('viewer1');
            const container2 = document.getElementById('viewer2');
            if (container1.style.display === 'none') {
                container1.style.display = 'flex';
                container2.style.display = 'none';
                document.getElementById('toggle-button').textContent = 'Comparar Modelos';
            } else {
                container1.style.display = 'none';
                container2.style.display = 'flex';
                document.getElementById('toggle-button').textContent = 'Tela Cheia';
            }
        });

        window.addEventListener('resize', () => {
            const width = window.innerWidth / 2;
            const height = window.innerHeight;
            renderer1.setSize(width, height);
            renderer2.setSize(width, height);
            camera1.aspect = width / height;
            camera2.aspect = width / height;
            camera1.updateProjectionMatrix();
            camera2.updateProjectionMatrix();
        });
    </script>
</body>
</html>
